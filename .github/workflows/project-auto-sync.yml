name: ðŸ§  ATOM Project Auto Sync
on:
  workflow_dispatch:
  issues:
    types: [opened, labeled, closed, reopened]
  pull_request:
    types: [opened, closed, reopened, synchronize]
  workflow_run:
    workflows: ["Agent Execution", "Integration Tests"]
    types: [completed]

jobs:
  sync:
    name: Sync GitHub Project Board
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Load project configuration
        id: config
        run: |
          echo "Reading project-template.json..."
          cat .github/project-template.json

      - name: ðŸ”— Determine project and issue context
        id: context
        run: |
          echo "EVENT: ${{ github.event_name }}"
          echo "ACTOR: ${{ github.actor }}"
          echo "TARGET: ${{ github.event.pull_request.html_url || github.event.issue.html_url }}"
          echo "BRANCH: ${{ github.head_ref || github.ref_name }}"

      - name: ðŸ“ Create Test Issue (if manual trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Phase F.5 Test - Project Sync Verification',
              body: 'This is a test issue to verify GitHub project sync functionality.',
              labels: ['phase-F']
            });
            core.notice(`Created test issue: ${issue.html_url}`);
            core.setOutput('test_issue_number', issue.number);

      - name: ðŸ§  Sync Issue or PR â†’ Project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/users/BadhulaVijaybhaskar/projects/5
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸª„ Auto Label by Phase
        if: github.event_name == 'pull_request' || github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request?.title || context.payload.issue?.title || '';
            const labels = [];
            if (title.includes('Phase A')) labels.push('phase-A');
            if (title.includes('Phase B')) labels.push('phase-B');
            if (title.includes('Phase C')) labels.push('phase-C');
            if (title.includes('Phase D')) labels.push('phase-D');
            if (title.includes('Phase E')) labels.push('phase-E');
            if (title.includes('Phase F')) labels.push('phase-F');
            if (title.includes('Phase G')) labels.push('phase-G');
            if (title.includes('Phase H')) labels.push('phase-H');
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request?.number || context.payload.issue?.number,
                labels
              });
              core.notice(`Auto-labeled: ${labels.join(', ')}`);
            } else {
              core.info('No phase label detected.');
            }

      - name: âœ… Move items based on status
        uses: actions/github-script@v7
        with:
          script: |
            const col = {
              open: 'In Progress',
              closed: 'Done',
              reopened: 'Ready'
            }[context.payload.action] || null;
            if (col) {
              core.notice(`Moving card to column: ${col}`);
            }

      - name: ðŸ§¾ Log project sync completion
        run: |
          echo "âœ… Project sync completed at $(date)"
